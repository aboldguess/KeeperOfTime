{% extends 'base.html' %}

{% block title %}Reports{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a> /
    <span>Reports</span>
</nav>
{% endblock %}

{% block content %}
<h2>Reports</h2>
<h3>Total Hours by User</h3>
<table id="user-report">
    <thead>
        <tr><th>User</th><th>Total Hours</th></tr>
    </thead>
    <tbody>
    {% for uid, username, hours in user_hours %}
        <tr class="user-row" data-user-id="{{ uid }}">
            <td>{{ username }}</td>
            <td>{{ hours or 0 }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<h3>Total Hours by Project</h3>
<table id="project-report">
    <thead>
        <tr><th>Project</th><th>Total Hours</th></tr>
    </thead>
    <tbody>
    {% for pid, name, hours in project_hours %}
        <tr class="project-row" data-project-id="{{ pid }}">
            <td>{{ name }}</td>
            <td>{{ hours or 0 }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
$(function(){
    // Expand rows progressively to show user -> project -> work package -> task

    // Fetch projects for a user
    $('#user-report').on('click', '.user-row', function(){
        const tr = $(this);
        const userId = tr.data('user-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }

        $.getJSON('/admin_dashboard/reports/user/' + userId + '/projects', function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr class="user-project-row expandable" data-user-id="' + userId + '" data-project-id="' + item.project_id + '">' +
                        '<td>' + item.project + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Project</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });

    // Fetch work packages for a user's project
    $('#user-report').on('click', '.user-project-row', function(e){
        e.stopPropagation();
        const tr = $(this);
        const userId = tr.data('user-id');
        const projectId = tr.data('project-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }

        $.getJSON('/admin_dashboard/reports/user/' + userId + '/project/' + projectId + '/work_packages', function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr class="user-wp-row expandable" data-user-id="' + userId + '" data-wp-id="' + item.work_package_id + '">' +
                        '<td>' + item.work_package + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Work Package</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });

    // Fetch tasks for a user's work package
    $('#user-report').on('click', '.user-wp-row', function(e){
        e.stopPropagation();
        const tr = $(this);
        const userId = tr.data('user-id');
        const wpId = tr.data('wp-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }

        $.getJSON('/admin_dashboard/reports/user/' + userId + '/work_package/' + wpId + '/tasks', function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr><td>' + item.task + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Task</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });

    // Project summary -> work packages
    $('#project-report').on('click', '.project-row', function(){
        const tr = $(this);
        const projectId = tr.data('project-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }

        $.getJSON('/admin_dashboard/reports/project/' + projectId + '/work_packages', function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr class="project-wp-row expandable" data-wp-id="' + item.work_package_id + '">' +
                        '<td>' + item.work_package + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Work Package</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });

    // Work package -> tasks (project centric)
    $('#project-report').on('click', '.project-wp-row', function(e){
        e.stopPropagation();
        const tr = $(this);
        const wpId = tr.data('wp-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }

        $.getJSON('/admin_dashboard/reports/work_package/' + wpId + '/tasks', function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr><td>' + item.task + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Task</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });
});
</script>
{% endblock %}
