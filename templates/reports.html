{% extends 'base.html' %}

{% block title %}Reports{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a> /
    <span>Reports</span>
</nav>
{% endblock %}

{% block content %}
<h2>Reports</h2>
<h3>Total Hours by User</h3>
<table id="user-report">
    <thead>
        <tr><th>User</th><th>Total Hours</th></tr>
    </thead>
    <tbody>
    {% for uid, username, hours in user_hours %}
        <tr class="user-row" data-user-id="{{ uid }}">
            <td>{{ username }}</td>
            <td>{{ hours or 0 }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<h3>Total Hours by Project</h3>
<table id="project-report">
    <thead>
        <tr><th>Project</th><th>Total Hours</th></tr>
    </thead>
    <tbody>
    {% for pid, name, hours in project_hours %}
        <tr class="project-row" data-project-id="{{ pid }}">
            <td>{{ name }}</td>
            <td>{{ hours or 0 }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
$(function(){
    // Expand user rows to show project/work package/task breakdown
    $('#user-report').on('click', '.user-row', function(){
        const tr = $(this);
        const userId = tr.data('user-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }
        $.getJSON('/admin_dashboard/reports/user/' + userId, function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr><td>' + item.project + ' / ' + item.work_package + ' / ' + item.task +
                        '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>Project / WP / Task</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });

    // Expand project rows to show work package/task breakdown
    $('#project-report').on('click', '.project-row', function(){
        const tr = $(this);
        const projectId = tr.data('project-id');
        let detail = tr.next('.detail-row');
        if(detail.length){
            detail.toggle();
            return;
        }
        $.getJSON('/admin_dashboard/reports/project/' + projectId, function(data){
            let rows = '';
            data.forEach(function(item){
                rows += '<tr><td>' + item.work_package + ' / ' + item.task + '</td><td>' + item.hours + '</td></tr>';
            });
            const html = '<tr class="detail-row"><td colspan="2"><table class="nested"><thead><tr><th>WP / Task</th><th>Hours</th></tr></thead><tbody>' +
                         rows + '</tbody></table></td></tr>';
            tr.after(html);
        });
    });
});
</script>
{% endblock %}
